# Multiple regression

```{r}
pacman::p_load(tidyverse, tidymodels, gafnts, here, janitor, stargazer)
```

## Simulation with multiple explenatory variables

```{r}
set.seed(123456789)
N <- 1000
a <- 2
b <- 3
c <- 4
u_x <- rnorm(N)

# Independence
alpha <- 0
x <- x1 <- (1 - alpha) * runif(N) + alpha*u_x
w <- w1 <- (1 - alpha) * runif(N) + alpha*u_x
u <- rnorm(N)
y <- a + b*x + c*w + u
lm1 <- lm(y ~ x)
lm2 <- lm(y ~ x + w)

# Dependence
alpha <- 0.5
x <- x2 <- (1 - alpha) * runif(N) + alpha*u_x
w <- w2 <- (1 - alpha) * runif(N) + alpha*u_x
u <- rnorm(N)
y <- a + b*x + c*w + u
lm3 <- lm(y ~ x)
lm4 <- lm(y ~ x + w)

# Extreme dependence
alpha <- 0.95
x <- x3 <- (1 - alpha) * runif(N) + alpha*u_x
w <- w3 <- (1 - alpha) * runif(N) + alpha*u_x
u <- rnorm(N)
y <- a + b*x + c*w + u
lm5 <- lm(y ~ x)
lm6 <- lm(y ~ x + w)
```

```{r}
stargazer(list(lm1, lm2, lm3, lm4, lm5, lm6), 
          order = c(1:6),
          digits = 2,
          keep = c(1:6),
          type = "text")
```

```{r}
cov(x1, w1)
cov(x2, w2)
t(x2) %*% w2
```

## Understanding multicollinearity with R

```{r}
X2 <- cbind(1, x3, w3)
solve(t(X2)%*%X2)%*%t(X2)%*%u

mean(u)
cov(x3, u)
cov(w3, u)

(1/N)*t(X2)%*%u

1/det(t(X2)%*%X2)
```

## Returns to schooling

```{r}
data <- 
  read_csv(here("data", "card.csv"), na = ".") %>% 
  clean_names() %>% 
  mutate(exp = age76 - ed76 - 6,
         exp2 = (exp^2)/100) %>% 
  drop_na()
```

```{r}
lm <- linear_reg() %>% set_engine("lm")

lm1 <- lm %>% fit(lwage76 ~ ed76, data)
lm2 <- lm %>% fit(lwage76 ~ ed76 + exp + exp2, data)
lm3 <- lm %>% fit(lwage76 ~ ed76 + exp + exp2 + black + reg76r, data)
lm4 <- lm %>% fit(lwage76 ~ ed76 + exp + exp2 + black + reg76r +
                    smsa76r + smsa66r + reg662 + reg663 + reg664 +
                    reg665 + reg666 + reg667 + reg668 + reg669, data)
```

```{r}
lm1 %>% peek()
lm2 %>% peek()
lm3 %>% peek()
lm4 %>% peek()
```

## Simulation of the dual path model

![](images/Screen%20Shot%202022-05-12%20at%2020.23.30.png){width="50%"}

```{r}
set.seed(123456789)

N <- 50

a <- 1
b <- 0
c <- 3
d <- 4

x <- round(runif(N)) 

u_w <- runif(N)
w <- d*x + u_w

u <- rnorm(N)
y <- a + b*x + c*w + u
```

```{r}
lm(y ~ x) %>% summary()
lm(y ~ x + w) %>% summary()
```

```{r}
e_hat <- lm(y ~ x)$coef[2]

c_hat <- lm(y ~ w)$coef[2]
d_hat <- lm(w ~ x)$coef[2]

e_hat - c_hat*d_hat
```

### Simulation

```{r}
set.seed(1)
N <- 1000
K <- 10000
mat <- matrix(NA, K, 3)

for(i in 1:K){
  x <- round(runif(N)) 
  u_w <- runif(N)
  w <- d*x + u_w
  u <- rnorm(N)
  y <- a + b*x + c*w + u
  
  mod <- summary(lm(y ~ x + w))
  mat[i,1] <- mod[[4]][2]
  mat[i,2] <- mod[[4]][8]
  
  e_hat <- lm(y ~ x)$coef[2]
  c_hat <- lm(y ~ w)$coef[2]
  d_hat <- lm(w ~ x)$coef[2]
  mat[i,3] <- e_hat - c_hat*d_hat
}

mat %>% 
  as_tibble() %>% 
  rename("est" = 1, "stat" = 2, "proposed" = 3) %>% 
  summary()
```

```{r}
mat %>% 
  as_tibble() %>% 
  ggplot(aes(V1))  + 
  geom_histogram(aes(y = ..density..),
                 bins = 30,
                 colour = 1, 
                 fill = "darkgray") +
  geom_density(lwd = 1, colour = 3,
               fill = 3, alpha = 0.2) +
  geom_vline(xintercept = 0, color = "red", size = 1) +
  you_want_it_darker()
```

```{r}
X <- cbind(1,x)
W <- cbind(1,w)
beta_tilde_hat <- solve(t(X)%*%X)%*%t(X)%*%y
Delta_hat <- solve(t(X)%*%X)%*%t(X)%*%W
gamma_hat <- solve(t(W)%*%W)%*%t(W)%*%y
beta_tilde_hat - Delta_hat%*%gamma_hat
```

## Are bankers racist or greedy?

```{r}
hmda <- read_csv(here("data", "hmda.csv"))

hmda_one <- 
  hmda %>% 
  mutate(deny = case_when(s7 == 1 | s7 == 2 ~ 0, s7 == 3 ~ 1, TRUE ~ NA_real_),
         black = s13 == 3)
```

```{r}
lm <- linear_reg() %>% set_engine("lm")
lm1 <- lm %>% fit(deny ~ black, hmda) %>% peek()
```

### Causal pathways of discrimination

![](images/Screen%20Shot%202022-05-13%20at%2016.33.17.png){width="50%"}

#### Estimating the direct effect

```{r}
hmda_two <-
  hmda %>% 
  mutate(lwage = ifelse(s31a == 0, 0, log(s31a)),
         emp = ifelse(s25a > 1000, NA, s25a)) %>% 
  rename("mhist" = s42, "chist" = s43, "phist" = s44) %>% 
  select(deny, black, lwage, emp, mhist, chist, phist) %>% 
  drop_na()
```

```{r}
Y2 <- hmda$deny
X2 <- cbind(1, hmda$black)
W2 <- cbind(1, hmda$lwage, hmda$chist, hmda$mhist, hmda$phist, hmda$emp)
```

```{r}
beta_tilde_hat <- solve(t(X2)%*%X2)%*%t(X2)%*%Y2
Delta_hat <- solve(t(X2)%*%X2)%*%t(X2)%*%W2
gamma_hat <- solve(t(W2)%*%W2)%*%t(W2)%*%Y2
beta_tilde_hat - Delta_hat%*%gamma_hat
```

#### Adding more variables

```{r}
hmda %>% 
  mutate(
    # Marital status of applicant
    married = s23a == "M",
    dr = ifelse(s45 > 999999, NA, s45)
  ) %>% glimpse
```
