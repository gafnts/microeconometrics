# Instrumental variables

```{r}
pacman::p_load(tidyverse, gafnts, here, janitor)
```

### Simulation of confounded data

![](images/Screen%20Shot%202022-05-18%20at%2016.48.43.png){width="50%"}

```{r}
set.seed(1)

N <- 1000

a <- 2
b <- 3
c <- 2
e <- 3
f <- -1
d <- 4

z <- runif(N)

u_1 <- rnorm(N, mean = 0, sd = 3)
u_2 <- rnorm(N, mean = 0, sd = 1)

x <- f + d*z + u_2 + c*u_1
y <- a + b*x + e*u_1

lm1 <- lm(y ~ x)
lm1 |> summary()
```

```{r}
# Backdoor relation
b + (e/c)

# Estimated x
lm1$coef[2]

# True effect
b
```

### Simulation of an IV estimator

![](images/Screen%20Shot%202022-05-18%20at%2016.49.03.png){width="50%"}

```{r}
bd_hat <- lm(y ~ z)$coef[2]
d_hat <- lm(y ~ x)$coef[2]

bd_hat/d_hat
```

```{r}
X <- cbind(1, x)
Z <- cbind(1, z)

beta_hat_ols <- solve(t(X)%*%X)%*%t(X)%*%y
beta_hat_iv <- solve(t(Z)%*%X)%*%t(Z)%*%y

beta_hat_ols
beta_hat_iv
```

### Bootstrap IV estimator

```{r}
lm_iv <- function(y, X_in, Z_in = X_in, Reps = 100, min_in = .05, max_in = .95) {
  
  X <- cbind(1, X_in)
  Z <- cbind(1, Z_in)
  
  bs_mat <- matrix(NA, Reps, dim(X)[2])
  N <- length(y)
  
  for (r in 1:Reps) {
    index_bs <- round(runif(N, min = 1, max = N))
    y_bs <- y[index_bs]
    X_bs <- X[index_bs,]
    Z_bs <- Z[index_bs,]
    bs_mat[r,] <- solve(t(Z_bs)%*%X_bs)%*%t(Z_bs)%*%y_bs
  }
  
  tab_res <- matrix(NA, dim(X)[2], 4)
  tab_res[, 1] <- colMeans(bs_mat)
  
  for (j in 1:dim(X)[2]) {
    tab_res[j, 2] <- sd(bs_mat[, j])
    tab_res[j, 3] <- quantile(bs_mat[, j], min_in)
    tab_res[j, 4] <- quantile(bs_mat[, j], max_in)
  }
  
  colnames(tab_res) <- c("coef", "sd", as.character(min_in), as.character(max_in))
  
  return(tab_res)
}
```

```{r}
# OLS
print(lm_iv(y, x), digits = 3)

# IV
print(lm_iv(y, x, z), digits = 3)
```

### Returns to schooling

```{r}
x <- 
  read_csv(here("data", "card.csv"), na = ".") |> 
  clean_names()
```

```{r}
x$lwage76 <- as.numeric(x$lwage76)
x1 <- x[is.na(x$lwage76)==0,]
x1$exp <- x1$age76 - x1$ed76 - 6
x1$exp2 <- (x1$exp^2)/100
```

```{r}
# OLS estimate
lm4 <- lm(lwage76 ~ ed76 + exp + exp2 + black + reg76r +
            smsa76r + smsa66r + reg662 + reg663 + reg664 +
            reg665 + reg666 + reg667 + reg668 + reg669, data = x1)

lm4 |> summary()
```

```{r}
# Intent to treat estimate
lm5 <- lm(lwage76 ~ nearc4 + exp + exp2 + black + reg76r +
            smsa76r + smsa66r + reg662 + reg663 + reg664 +
            reg665 + reg666 + reg667 + reg668 + reg669, data = x1)

lm5 |> summary()
```

```{r}
# Effect of instrument on explanatory variable
lm6 <- lm(ed76 ~ nearc4 + exp + exp2 + black + reg76r +
            smsa76r + smsa66r + reg662 + reg663 + reg664 +
            reg665 + reg666 + reg667 + reg668 + reg669, data = x1)

lm6 |> summary()
```

```{r}
# IV estimate of return to schooling
lm5$coefficients[2]/lm6$coefficients[2]
```

### Matrix algebra IV estimates of returns to schooling

```{r}
y <- x1$lwage76

X <- cbind(x1$ed76, x1$exp, x1$exp2, x1$black, x1$reg76r,
            x1$smsa76r, x1$smsa66r, x1$reg662, x1$reg663,
            x1$reg664, x1$reg665, x1$reg666, x1$reg667,
            x1$reg668, x1$reg669)

x1$age2 <- x1$age76^2

Z1 <- cbind(x1$nearc4, x1$age76, x1$age2, x1$black,
             x1$reg76r,x1$smsa76r, x1$smsa66r, x1$reg662,
             x1$reg663,x1$reg664, x1$reg665, x1$reg666,
             x1$reg667, x1$reg668, x1$reg669)

res <- lm_iv(y,X,Z1, Reps = 1000)

rownames(res) <- c("intercept","ed76","exp", "exp2", "black",
                   "reg76r","smsa76r", "smsa66r",
                   "reg662","reg663","reg664", "reg665",
                   "reg666","reg667", "reg668", "reg669")

res
```

### Concerns with distance to college

```{r}
data |> 
  mutate(near = fct_recode(factor(nearc4), 
                           "Not near" = "0", "Near" = "1"),
         exp = age76 - ed76 - 6) |> 
  group_by(near) |> 
  summarise(
    ed76 = mean(ed76),
    exp = mean(exp),
    black = mean(black),
    south66 = mean(south66),
    smsa66r = mean(smsa66r),
    reg76r = mean(reg76r),
    smsa76r = mean(smsa76r),
  )
```
